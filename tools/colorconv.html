<div class="tool-container color-tool">
    <div class="custom-picker-area">
        <div class="sv-box" id="svBox">
            <div class="sv-bg-white"></div>
            <div class="sv-bg-black"></div>
            <div class="sv-cursor" id="svCursor"></div>
        </div>
        <div class="hue-slider" id="hueSlider">
            <div class="hue-cursor" id="hueCursor"></div>
        </div>
    </div>
    
    <div class="color-grid">
        <div class="input-group">
            <label>HEX</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="hexIn" value="#3498DB" oninput="handleColorChange('hex')" />
                <button class="btn btn--outline btn--sm copy-btn" onclick="copyValue('hexIn', this)" title="Copy HEX"><i data-lucide="copy"></i></button>
            </div>
        </div>
        <div class="input-group">
            <label>RGB (e.g., 52, 152, 219)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="rgbIn" value="52, 152, 219" oninput="handleColorChange('rgb')" />
                <button class="btn btn--outline btn--sm copy-btn" onclick="copyValue('rgbIn', this)" title="Copy RGB"><i data-lucide="copy"></i></button>
            </div>
        </div>
        <div class="input-group">
            <label>CMYK (%, e.g., 76, 31, 0, 14)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="cmykIn" value="76, 31, 0, 14" oninput="handleColorChange('cmyk')" />
                <button class="btn btn--outline btn--sm copy-btn" onclick="copyValue('cmykIn', this)" title="Copy CMYK"><i data-lucide="copy"></i></button>
            </div>
        </div>
        <div class="input-group">
            <label>HSV (e.g., 204, 76, 86)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="hsvIn" value="204, 76, 86" oninput="handleColorChange('hsv')" />
                <button class="btn btn--outline btn--sm copy-btn" onclick="copyValue('hsvIn', this)" title="Copy HSV"><i data-lucide="copy"></i></button>
            </div>
        </div>
    </div>

    <div class="special-colors">
        <div class="hash-row">
            <label id="mcLabelText"><i data-lucide="pickaxe" style="width:16px;"></i> Closest Minecraft Code</label>
            <div class="hash-value-box">
                <code id="mcOut">&b (Aqua)</code>
                <button class="btn btn--outline btn--sm copy-btn-box" onclick="copyTextContent('mcOut', this)" title="Copy Minecraft Code"><i data-lucide="copy"></i></button>
            </div>
        </div>
        <div class="hash-row">
            <label style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <span id="pantoneLabelText" style="display: flex; align-items: center; gap: 6px;"><i data-lucide="palette" style="width:16px;"></i> Closest Pantone</span>
                <a href="files/pantonechart.pdf" target="_blank" class="btn btn--outline btn--sm" style="padding: 2px 8px; font-size: 0.8rem; text-decoration: none;">
                    <i data-lucide="file-text" style="width: 12px; margin-right: 4px;"></i> View Full Chart
                </a>
            </label>
            <div class="hash-value-box">
                <code id="pantoneOut">Loading database...</code>
                <button class="btn btn--outline btn--sm copy-btn-box" onclick="copyTextContent('pantoneOut', this)" title="Copy Pantone"><i data-lucide="copy"></i></button>
            </div>
        </div>
    </div>

    <div class="trademark-note">
        * This tool is provided for free, educational, and personal use. It has no affiliation with, nor is it endorsed by, Pantone LLC or Mojang AB. "Pantone" and "Minecraft" are registered trademarks of their respective owners.
    </div>
</div>

<style>
    .color-tool { background: var(--color-bg-1); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--color-border); }
    
    /* Custom Picker CSS */
    .custom-picker-area { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
    .sv-box { width: 100%; height: 200px; position: relative; border-radius: 8px; overflow: hidden; cursor: crosshair; background-color: #0088ff; border: 1px solid var(--color-border); box-shadow: inset 0 0 4px rgba(0,0,0,0.2); }
    .sv-bg-white { position: absolute; inset: 0; background: linear-gradient(to right, #fff, rgba(255,255,255,0)); pointer-events: none; }
    .sv-bg-black { position: absolute; inset: 0; background: linear-gradient(to top, #000, rgba(0,0,0,0)); pointer-events: none; }
    .sv-cursor { position: absolute; width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; box-shadow: 0 0 4px rgba(0,0,0,0.6), inset 0 0 2px rgba(0,0,0,0.4); z-index: 2; }

    .hue-slider { width: 100%; height: 24px; background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%); position: relative; border-radius: 12px; cursor: pointer; border: 1px solid var(--color-border); }
    .hue-cursor { position: absolute; width: 20px; height: 28px; background: white; border: 2px solid #ccc; border-radius: 4px; top: 50%; transform: translate(-50%, -50%); pointer-events: none; box-shadow: 0 1px 4px rgba(0,0,0,0.4); z-index: 2; }

    .color-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--color-primary); font-size: 0.85rem; }
    .input-group input { width: 100%; padding: 10px; border: 1px solid var(--color-border); background: var(--color-bg-2); color: var(--color-text); border-radius: 4px; font-family: var(--font-family-mono); }
    
    .copy-btn { width: 40px; display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0; }
    .copy-btn-box { width: 40px; border: none; border-left: 1px solid var(--color-border); border-radius: 0 4px 4px 0; display: flex; align-items: center; justify-content: center; background: var(--color-bg-2); }
    .copy-btn-box:hover { background: var(--color-border); }

    .special-colors { background: var(--color-bg-2); padding: 15px; border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 15px; }
    .hash-row { margin-bottom: 15px; }
    .hash-row:last-child { margin-bottom: 0; }
    .hash-row label { display: flex; align-items: center; gap: 6px; font-weight: bold; margin-bottom: 5px; color: var(--color-primary); font-size: 0.9rem; }
    .hash-value-box { display: flex; background: var(--color-bg-1); border: 1px solid var(--color-border); border-radius: 4px; }
    .hash-value-box code { padding: 10px; font-family: var(--font-family-mono); font-size: 0.9rem; width: 100%; }
    
    .trademark-note { font-size: 0.75rem; color: var(--color-text-secondary); text-align: center; border-top: 1px solid var(--color-border); padding-top: 15px; line-height: 1.4; }
</style>

<script>
    if(window.lucide) window.lucide.createIcons();

    // Copy Functions
    window.copyValue = function(id, btn) {
        const val = document.getElementById(id).value;
        navigator.clipboard.writeText(val).then(() => {
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" style="color: var(--color-success); width:16px;"></i>`;
            if(window.lucide) window.lucide.createIcons();
            setTimeout(() => { btn.innerHTML = originalHtml; if(window.lucide) window.lucide.createIcons(); }, 1500);
        });
    };

    window.copyTextContent = function(id, btn) {
        const val = document.getElementById(id).textContent;
        navigator.clipboard.writeText(val).then(() => {
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" style="color: var(--color-success); width:16px;"></i>`;
            if(window.lucide) window.lucide.createIcons();
            setTimeout(() => { btn.innerHTML = originalHtml; if(window.lucide) window.lucide.createIcons(); }, 1500);
        });
    };

    // Internals
    window.currentH = 204;
    window.currentS = 76;
    window.currentV = 86;
    window.lastRGB = {r: 52, g: 152, b: 219};

    const mcColors = [
        { c: '&0', n: 'Black', r: 0, g: 0, b: 0 }, { c: '&1', n: 'Dark Blue', r: 0, g: 0, b: 170 },
        { c: '&2', n: 'Dark Green', r: 0, g: 170, b: 0 }, { c: '&3', n: 'Dark Aqua', r: 0, g: 170, b: 170 },
        { c: '&4', n: 'Dark Red', r: 170, g: 0, b: 0 }, { c: '&5', n: 'Dark Purple', r: 170, g: 0, b: 170 },
        { c: '&6', n: 'Gold', r: 255, g: 170, b: 0 }, { c: '&7', n: 'Gray', r: 170, g: 170, b: 170 },
        { c: '&8', n: 'Dark Gray', r: 85, g: 85, b: 85 }, { c: '&9', n: 'Blue', r: 85, g: 85, b: 255 },
        { c: '&a', n: 'Green', r: 85, g: 255, b: 85 }, { c: '&b', n: 'Aqua', r: 85, g: 255, b: 255 },
        { c: '&c', n: 'Red', r: 255, g: 85, b: 85 }, { c: '&d', n: 'Light Purple', r: 255, g: 85, b: 255 },
        { c: '&e', n: 'Yellow', r: 255, g: 255, b: 85 }, { c: '&f', n: 'White', r: 255, g: 255, b: 255 }
    ];

    window.pantoneDB = [
        { p: 'PMS 2925 C', r: 0, g: 156, b: 222 }
    ];

    fetch('data/pantone-numbers.json')
        .then(res => res.json())
        .then(data => {
            window.pantoneDB = Object.entries(data).map(([code, info]) => {
                let hex = info.hex.replace('#', '');
                let bigint = parseInt(hex, 16);
                return { 
                    p: `PMS ${code} (${info.name})`, 
                    r: (bigint >> 16) & 255, 
                    g: (bigint >> 8) & 255, 
                    b: bigint & 255 
                };
            });
            updatePantoneDisplay(window.lastRGB.r, window.lastRGB.g, window.lastRGB.b);
        })
        .catch(err => console.error('Error loading Pantone JSON:', err));

    window.hsvToRgb = function(h, s, v) {
        h /= 360; s /= 100; v /= 100;
        let i = Math.floor(h * 6), f = h * 6 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
        let r, g, b;
        switch (i % 6) {
            case 0: r=v; g=t; b=p; break; case 1: r=q; g=v; b=p; break;
            case 2: r=p; g=v; b=t; break; case 3: r=p; g=q; b=v; break;
            case 4: r=t; g=p; b=v; break; case 5: r=v; g=p; b=q; break;
        }
        return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
    }

    window.updatePickerVisuals = function() {
        document.getElementById('svBox').style.backgroundColor = `hsl(${window.currentH}, 100%, 50%)`;
        document.getElementById('svCursor').style.left = `${window.currentS}%`;
        document.getElementById('svCursor').style.top = `${100 - window.currentV}%`;
        document.getElementById('hueCursor').style.left = `${(window.currentH / 360) * 100}%`;
    }

    const svBox = document.getElementById('svBox');
    const hueSlider = document.getElementById('hueSlider');

    window.updateSV = function(e) {
        const rect = svBox.getBoundingClientRect();
        let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        let y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
        window.currentS = (x / rect.width) * 100;
        window.currentV = 100 - ((y / rect.height) * 100);
        
        window.updatePickerVisuals();
        let rgb = window.hsvToRgb(window.currentH, window.currentS, window.currentV);
        window.updateAllColors(rgb.r, rgb.g, rgb.b, 'picker');
    }

    window.updateHue = function(e) {
        const rect = hueSlider.getBoundingClientRect();
        let x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        window.currentH = (x / rect.width) * 360;
        
        window.updatePickerVisuals();
        let rgb = window.hsvToRgb(window.currentH, window.currentS, window.currentV);
        window.updateAllColors(rgb.r, rgb.g, rgb.b, 'picker');
    }

    function setupDragLogic(element, updateFunc) {
        element.addEventListener('mousedown', (e) => startDrag(e, updateFunc));
        element.addEventListener('touchstart', (e) => startDrag(e.touches[0], updateFunc), {passive: true});

        function startDrag(e, func) {
            func(e);
            function move(ev) { func(ev.touches ? ev.touches[0] : ev); }
            function up() {
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', up);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('touchend', up);
            }
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', up);
            document.addEventListener('touchmove', move, {passive: true});
            document.addEventListener('touchend', up);
        }
    }

    setupDragLogic(svBox, window.updateSV);
    setupDragLogic(hueSlider, window.updateHue);

    window.handleColorChange = function(source) {
        let r, g, b;

        if (source === 'hex') {
            let hex = document.getElementById('hexIn').value.replace('#','');
            if(hex.length === 3) hex = hex.split('').map(x => x+x).join('');
            if(hex.length !== 6) return;
            r = parseInt(hex.substring(0,2), 16);
            g = parseInt(hex.substring(2,4), 16);
            b = parseInt(hex.substring(4,6), 16);
        } else if (source === 'rgb') {
            const parts = document.getElementById('rgbIn').value.split(',').map(Number);
            if(parts.length !== 3) return;
            r = parts[0]; g = parts[1]; b = parts[2];
        } else if (source === 'cmyk') {
            const p = document.getElementById('cmykIn').value.split(',').map(Number);
            if(p.length !== 4) return;
            r = 255 * (1 - p[0]/100) * (1 - p[3]/100);
            g = 255 * (1 - p[1]/100) * (1 - p[3]/100);
            b = 255 * (1 - p[2]/100) * (1 - p[3]/100);
        } else if (source === 'hsv') {
            const p = document.getElementById('hsvIn').value.split(',').map(Number);
            if(p.length !== 3) return;
            let rgb = window.hsvToRgb(p[0], p[1], p[2]);
            r = rgb.r; g = rgb.g; b = rgb.b;
        }

        r = Math.min(255, Math.max(0, Math.round(r || 0)));
        g = Math.min(255, Math.max(0, Math.round(g || 0)));
        b = Math.min(255, Math.max(0, Math.round(b || 0)));

        updateAllColors(r, g, b, source);
    };

    window.updatePantoneDisplay = function(r, g, b) {
        if(window.pantoneDB.length === 0) return;
        
        let closestPantone = window.pantoneDB.reduce((prev, curr) => {
            let dCurr = Math.pow(curr.r - r, 2) + Math.pow(curr.g - g, 2) + Math.pow(curr.b - b, 2);
            let dPrev = Math.pow(prev.r - r, 2) + Math.pow(prev.g - g, 2) + Math.pow(prev.b - b, 2);
            return dCurr < dPrev ? curr : prev;
        });

        let distP = Math.pow(closestPantone.r - r, 2) + Math.pow(closestPantone.g - g, 2) + Math.pow(closestPantone.b - b, 2);
        let isExact = (distP === 0);

        document.getElementById('pantoneLabelText').innerHTML = `<i data-lucide="palette" style="width:16px;"></i> ${isExact ? 'Exact Pantone Match' : 'Closest Pantone Match'}`;
        document.getElementById('pantoneOut').textContent = closestPantone.p;
        if(window.lucide) window.lucide.createIcons();
    }

    window.updateAllColors = function(r, g, b, skipSource) {
        window.lastRGB = {r, g, b};

        if (skipSource !== 'picker') {
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h = 0, s = 0, v = max / 255;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max !== min) {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            window.currentH = h * 360;
            window.currentS = s * 100;
            window.currentV = v * 100;
            window.updatePickerVisuals();
        }

        let hexColor = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();

        if (skipSource !== 'hex') document.getElementById('hexIn').value = hexColor;
        if (skipSource !== 'rgb') document.getElementById('rgbIn').value = `${r}, ${g}, ${b}`;
        
        if (skipSource !== 'cmyk') {
            let c = 1 - (r/255), m = 1 - (g/255), y = 1 - (b/255);
            let k = Math.min(c, m, y);
            c = Math.round((c - k) / (1 - k) * 100 || 0);
            m = Math.round((m - k) / (1 - k) * 100 || 0);
            y = Math.round((y - k) / (1 - k) * 100 || 0);
            k = Math.round(k * 100);
            document.getElementById('cmykIn').value = `${c}, ${m}, ${y}, ${k}`;
        }
        
        if (skipSource !== 'hsv') document.getElementById('hsvIn').value = `${Math.round(window.currentH)}, ${Math.round(window.currentS)}, ${Math.round(window.currentV)}`;

        // Minecraft Closest Match logic
        let closestMC = mcColors.reduce((prev, curr) => {
            let dCurr = Math.pow(curr.r - r, 2) + Math.pow(curr.g - g, 2) + Math.pow(curr.b - b, 2);
            let dPrev = Math.pow(prev.r - r, 2) + Math.pow(prev.g - g, 2) + Math.pow(prev.b - b, 2);
            return dCurr < dPrev ? curr : prev;
        });

        let distMC = Math.pow(closestMC.r - r, 2) + Math.pow(closestMC.g - g, 2) + Math.pow(closestMC.b - b, 2);
        let isExactMC = (distMC === 0);

        document.getElementById('mcLabelText').innerHTML = `<i data-lucide="pickaxe" style="width:16px;"></i> ${isExactMC ? 'Exact Minecraft Code' : 'Closest Minecraft Code'}`;
        document.getElementById('mcOut').textContent = `${closestMC.c} (${closestMC.n})`;

        updatePantoneDisplay(r, g, b);
    }

    // Init
    window.updatePickerVisuals();
</script>